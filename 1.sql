-- Publisher Table
CREATE TABLE PUBLISHER (
    NAME VARCHAR2(20) PRIMARY KEY,
    PHONE NUMBER,
    ADDRESS VARCHAR2(20)
);

-- Book Table
CREATE TABLE BOOK (
    BOOK_ID INTEGER PRIMARY KEY,
    TITLE VARCHAR2(20),
    PUB_YEAR VARCHAR2(20),
    PUBLISHER_NAME VARCHAR2(20),
    FOREIGN KEY (PUBLISHER_NAME) REFERENCES PUBLISHER(NAME) ON DELETE CASCADE
);

-- Book Authors Table
CREATE TABLE BOOK_AUTHORS (
    AUTHOR_NAME VARCHAR2(20),
    BOOK_ID INTEGER,
    PRIMARY KEY (BOOK_ID, AUTHOR_NAME),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE
);

-- Library Branch Table
CREATE TABLE LIBRARY_BRANCH (
    BRANCH_ID INTEGER PRIMARY KEY,
    BRANCH_NAME VARCHAR2(50),
    ADDRESS VARCHAR2(50)
);

-- Book Copies Table
CREATE TABLE BOOK_COPIES (
    NO_OF_COPIES INTEGER,
    BOOK_ID INTEGER,
    BRANCH_ID INTEGER,
    PRIMARY KEY (BOOK_ID, BRANCH_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    FOREIGN KEY (BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE
);

-- Card Table
CREATE TABLE CARD (
    CARD_NO INTEGER PRIMARY KEY
);

-- Book Lending Table
CREATE TABLE BOOK_LENDING (
    DATE_OUT DATE,
    DUE_DATE DATE,
    BOOK_ID INTEGER,
    BRANCH_ID INTEGER,
    CARD_NO INTEGER,
    PRIMARY KEY (BOOK_ID, BRANCH_ID, CARD_NO),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    FOREIGN KEY (BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE,
    FOREIGN KEY (CARD_NO) REFERENCES CARD(CARD_NO) ON DELETE CASCADE
    
);

-- Insert into PUBLISHER
INSERT INTO PUBLISHER VALUES ('MCGRAW-HILL', 9989076587, 'BANGALORE');
INSERT INTO PUBLISHER VALUES ('PEARSON', 9889076565, 'NEWDELHI');
INSERT INTO PUBLISHER VALUES ('OUP', 9112233445, 'CHENNAI');
INSERT INTO PUBLISHER VALUES ('WILEY', 9001122334, 'HYDERABAD');
INSERT INTO PUBLISHER VALUES ('TATA-MCGRAW', 8899776655, 'MUMBAI');

-- Insert into BOOK
INSERT INTO BOOK VALUES (1, 'DBMS', 'JAN-2017', 'MCGRAW-HILL');
INSERT INTO BOOK VALUES (2, 'ADBMS', 'JUN-2016', 'MCGRAW-HILL');
INSERT INTO BOOK VALUES (3, 'OS', 'FEB-2015', 'PEARSON');
INSERT INTO BOOK VALUES (4, 'CN', 'AUG-2018', 'OUP');
INSERT INTO BOOK VALUES (5, 'SE', 'SEP-2019', 'TATA-MCGRAW');

-- Insert into BOOK_AUTHORS
INSERT INTO BOOK_AUTHORS VALUES ('NAVATHE', 1);
INSERT INTO BOOK_AUTHORS VALUES ('GALVIN', 2);
INSERT INTO BOOK_AUTHORS VALUES ('TANENBAUM', 3);
INSERT INTO BOOK_AUTHORS VALUES ('FOROUZAN', 4);
INSERT INTO BOOK_AUTHORS VALUES ('SOMMERVILLE', 5);

-- Insert into LIBRARY_BRANCH
INSERT INTO LIBRARY_BRANCH VALUES (10, 'RR NAGAR', 'BANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (11, 'NITTE', 'BANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (12, 'JAYANAGAR', 'BANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (13, 'KENGERI', 'BANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (14, 'VIJAYNAGAR', 'BANGALORE');

-- Insert into BOOK_COPIES
INSERT INTO BOOK_COPIES VALUES (10, 1, 10);
INSERT INTO BOOK_COPIES VALUES (5, 1, 11);
INSERT INTO BOOK_COPIES VALUES (3, 2, 12);
INSERT INTO BOOK_COPIES VALUES (6, 3, 13);
INSERT INTO BOOK_COPIES VALUES (4, 4, 14);

-- Insert into CARD
INSERT INTO CARD VALUES (101);
INSERT INTO CARD VALUES (102);
INSERT INTO CARD VALUES (103);
INSERT INTO CARD VALUES (104);
INSERT INTO CARD VALUES (105);

INSERT INTO BOOK_LENDING VALUES ('01-JAN-17', '01-JUN-17', 1, 10, 101);
INSERT INTO BOOK_LENDING VALUES ('11-JAN-17', '11-MAR-17', 3, 14, 101);
INSERT INTO BOOK_LENDING VALUES ('05-FEB-17', '05-JUL-17', 2, 11, 102);
INSERT INTO BOOK_LENDING VALUES ('15-MAR-17', '15-SEP-17', 4, 13, 103);
INSERT INTO BOOK_LENDING VALUES ('01-APR-17', '01-OCT-17', 5, 12, 104);



--a. Retrieve all book details with authors and copies
SELECT 
    B.Book_id,
    B.Title,
    B.Publisher_Name,
    BA.Author_Name,
    BC.Branch_id,
    LB.Branch_Name,
    BC.No_of_Copies
FROM 
    BOOK B
LEFT JOIN BOOK_AUTHORS BA ON B.Book_id = BA.Book_id
LEFT JOIN BOOK_COPIES BC ON B.Book_id = BC.Book_id
LEFT JOIN LIBRARY_BRANCH LB ON BC.Branch_id = LB.Branch_id;

--b
SELECT CARD_NO FROM BOOK LENDING WHERE DATE_OUT BETWEEN '01-JAN-2020' AND '01-DEC-2020' 
GROUP BY CARD_NO 
HAVING COUNT (*)>2; 

--c
DELETE FROM BOOK WHERE BOOK_ID=3; 

--d

SELECT 
    Publisher_Name,
    COUNT(*) AS Total_Books
FROM 
    BOOK
GROUP BY 
    Publisher_Name;

--e
CREATE VIEW V_BOOKS AS 
SELECT B.BOOK_ID, B.TITLE, C.NO_OF_COPIES 
FROM BOOK B, BOOK_COPIES C, LIBRARY_BRANCH L 
WHERE B.BOOK_ID = C.BOOK_ID 
AND C.BRANCH_ID = L.BRANCH_ID;

-- To view the result:
SELECT * FROM V_BOOKS;
